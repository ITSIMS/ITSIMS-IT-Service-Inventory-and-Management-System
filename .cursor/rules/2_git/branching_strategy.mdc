---
description: Стратегия работы с ветками в проекте ITSIMS (Task-Based Branching)
globs: []
alwaysApply: true
---

# Стратегия работы с ветками (Task-Based Branching)

> **Связанные документы:**
> - `commit_format.mdc` — правила оформления сообщений коммитов
> - `commit_authorship.mdc` — инструкции по созданию коммитов от разных авторов

## Общая концепция

В проекте ITSIMS используется **Task-Based Branching** — каждая задача из `task-tracker/` выполняется в отдельной ветке.

### Основные принципы

1. **Ветка main** — только для "мета-работы" (создание задач, отчетов, обновление правил)
2. **Ветки задач** — вся работа по конкретным задачам (артефакты, документы, код)
3. **Merge без PR** — прямой merge в main с сохранением истории (`--no-ff`)
4. **Ветки не удаляются** — остаются в истории после merge

---

## Именование веток

### Формат

```
task/<ГГГГ-ММ-ДД>_<фамилия-латиницей>
```

Дата — это дата создания задачи (из имени файла)

### Примеры

```
task/2025-12-03_valkovets
task/2025-11-28_nosov
task/2025-11-23_grechko
```

### Индексация при нескольких задачах

Если у одного исполнителя несколько задач с одинаковой датой, ветки индексируются аналогично файлам задач:

**Формат:** `task/<ГГГГ-ММ-ДД>_<фамилия>_<индекс>`

**Примеры:**
```
task/2025-12-09_koganovsky_1
task/2025-12-09_koganovsky_2
task/2025-12-09_zatsepilin_1
task/2025-12-09_zatsepilin_2
```

**Правила:**
- Индекс ветки соответствует индексу файла задачи
- Ветка без индекса может существовать для первой задачи, но при появлении второй — обе ветки должны быть проиндексированы

---

## Workflow работы с веткой на примере полного цикла задачи

### Этап 1: Создание задачи (в main)

```bash
# Убедитесь, что вы в main
git checkout main
git pull origin main

# Создайте файл задачи
# task-tracker/1_sprint/2025-12-03_Вальковец.md

# Добавьте и закоммитьте от имени Баранова (создатель задач)
git add task-tracker/1_sprint/2025-12-03_Вальковец.md
./tools/commit_as.sh baranov "feat(tasks): добавить задачу для Вальковца"
git push origin main
```

**Примеры того, что может происходить прямо в main (как правило, от лица Баранова):**
- ✅ Создание задач
- ✅ Создание еженедельных отчетов
- ✅ Обновление README, правил, инструкций
- ✅ Изменения в структуре проекта, `.gitignore`

---

### Этап 2: Начало работы (создание ветки)

```bash
# Создайте ветку для задачи
git checkout -b task/2025-12-03_valkovets

# Переместите задачу в "в работе"
git mv task-tracker/1_sprint/2025-12-03_Вальковец.md task-tracker/2_in_progress/

# Коммит от имени исполнителя
git add task-tracker/2_in_progress/2025-12-03_Вальковец.md
./tools/commit_as.sh valkovets "chore(tasks): взять задачу в работу"

# Отправьте ветку на GitHub
git push origin task/2025-12-03_valkovets
```

> **Примечание:** Правила создания коммитов и определения автора см. в `git_creating_commits.mdc`

---

### Этап 3: Работа над задачей (в ветке)

```bash
# Вы в ветке task/2025-12-03_valkovets
# Вся работа по задаче происходит здесь!

# Пример: редактирование ТЗ
git add artifacts/1_technical.md
./tools/commit_as.sh valkovets "feat(spec): добавить раздел требований к API"
git push origin task/2025-12-03_valkovets

# Пример: создание системных требований
git add artifacts/2_system_requirements.md
./tools/commit_as.sh valkovets "feat(spec): создать документ системных требований"
git push origin task/2025-12-03_valkovets

# Продолжайте работу с регулярными коммитами
```

> **Важно:** Формат сообщений коммитов см. в `git_commit_messages.mdc`

---

### Этап 4: Завершение задачи

```bash
# Всё ещё в ветке task/2025-12-03_valkovets

# Переместите задачу в "выполнено"
git mv task-tracker/2_in_progress/2025-12-03_Вальковец.md task-tracker/3_done/

# Коммит от имени исполнителя
git add task-tracker/3_done/2025-12-03_Вальковец.md
./tools/commit_as.sh valkovets "chore(tasks): завершить задачу"
git push origin task/2025-12-03_valkovets
```

---

### Этап 5: Merge в main

```bash
# Переключитесь на main
git checkout main
git pull origin main

# Merge с помощью скрипта от имени исполнителя (важно!)
./tools/merge_as.sh valkovets task/2025-12-03_valkovets

# Отправьте обновленный main
git push origin main

# Ветка остается (НЕ удаляем!)
```

**Важно использовать `merge_as.sh`:**
- Устанавливает правильное авторство merge commit (от имени исполнителя)
- Автоматически использует `--no-ff` для сохранения истории
- Без скрипта merge будет от имени retrobanner, что нарушает правила

**Проверка корректности merge:**
```bash
# После merge проверьте авторство последнего коммита
git log -1 --format="Author: %an <%ae>%nCommitter: %cn <%ce>"

# Оба поля должны содержать имя и email исполнителя задачи
# Например: Author: Данила Вальковец <dahnh33@gmail.com>
#           Committer: Данила Вальковец <dahnh33@gmail.com>
```

**Почему `--no-ff` (используется автоматически в скрипте)?**
- Создает merge commit даже если возможен fast-forward
- Сохраняет всю историю ветки
- В истории видно, что работа велась в отдельной ветке

---

## Параллельная работа над задачами

Если нужно работать над несколькими задачами одновременно:

```bash
# Задача 1
git checkout main
git checkout -b task/2025-12-03_valkovets
# работаете...
git push origin task/2025-12-03_valkovets

# Задача 2 (создаем от main!)
git checkout main
git pull origin main
git checkout -b task/2025-12-04_nosov
# работаете...
git push origin task/2025-12-04_nosov

# Переключение между задачами
git checkout task/2025-12-03_valkovets  # работа над задачей 1
git checkout task/2025-12-04_nosov      # работа над задачей 2
```

### Если задача 2 завершилась раньше

```bash
# Мержим задачу 2 от имени исполнителя
git checkout main
git pull origin main
./tools/merge_as.sh nosov task/2025-12-04_nosov
git push origin main

# Возвращаемся к задаче 1
git checkout task/2025-12-03_valkovets

# Если нужны изменения из main — подтягиваем их
git merge main

# Завершаем работу и мержим задачу 1 от имени исполнителя
git checkout main
./tools/merge_as.sh valkovets task/2025-12-03_valkovets
git push origin main
```

---

## Правила для ИИ агента

1. **Автоматически создавай ветку** при начале работы над задачей
2. **Все изменения по задаче** делай в ветке задачи, не в main
3. **Используй `./tools/merge_as.sh`** для merge веток (НЕ `git merge` напрямую)
4. **Не удаляй ветки** после merge
5. **Следуй формату именования** веток строго
6. **В main** работай только при создании задач/отчетов/правил
7. **После merge** проверяй авторство командой `git log -1 --format="..."`
