# Кандидат 2: Ролевая модель с правами на уровне сервисов

## Описание модуля

Модуль **«Управление доступом и ролями пользователей»** отвечает за разграничение прав доступа к IT-сервисам и их документации в системе ITSIMS.

Система поддерживает четыре роли (Администратор системы, Администратор сервиса, Специалист по обслуживанию, Обычный сотрудник) и реализует **двухуровневую модель доступа**: глобальные права (роль в системе) и индивидуальные права (роль в контексте конкретного сервиса). Каждый пользователь может иметь разные роли для разных сервисов.

---

## Почему этот модуль уникален

1. **Двухуровневая авторизация.** Права определяются не только глобальной ролью, но и назначениями на уровне каждого сервиса. Это не банальный «админ/юзер», а полноценная матрица доступа
2. **Перекрёстное влияние.** Модуль пронизывает всю систему: каталог сервисов, документацию, обслуживание, связи, аудит. Каждый endpoint проверяет права, и ошибка в авторизации — критическая уязвимость
3. **Сложная комбинаторика ролей.** Один пользователь может быть администратором сервиса A, специалистом по обслуживанию сервиса B и обычным сотрудником сервиса C одновременно. Это создаёт множество граничных случаев
4. **Безопасность.** Верификация ролевой модели — это по сути тестирование безопасности: эскалация привилегий, обход авторизации, несанкционированный доступ к документации

---

## Покрытие требованиями

### Техническое задание (ТЗ)

| ID | Требование |
| --- | --- |
| TS-F025 | Поддержка ролей: Администратор системы, Администратор сервиса, Специалист по обслуживанию, Обычный сотрудник |
| TS-F026 | Автоматическое назначение прав администратора системы для должности «Технический директор» |
| TS-F027 | Назначение пользователя администратором конкретного IT-сервиса |
| TS-F028 | Назначение индивидуальных прав доступа к IT-сервису для каждого пользователя |
| TS-F029 | Разграничение доступа к документации: обычный сотрудник видит только «для пользователей», специалист — все |
| TS-F030 | Администратор сервиса управляет правами доступа к данному сервису |
| TS-F031 | Настройка прав доступа к отдельным документам и папкам внутри каталога |
| TS-F056 | Скрытие элементов интерфейса для пользователей без прав на редактирование |
| TS-F057 | Сообщение «Доступ запрещён» при попытке несанкционированного доступа через прямые запросы |
| TS-F060 | Создание и управление учётными записями пользователей |

**Приоритет по MoSCoW:** Must have (обязательно) — это ядро системы, без которого она не функционирует.

### Системные требования (SR)

| ID | Требование |
| --- | --- |
| SR-F068 | Создание новых пользователей администратором системы |
| SR-F069 | Обязательные атрибуты: имя, фамилия, должность, отдел, email, логин, пароль |
| SR-F070 | Проверка уникальности логина |
| SR-F071 | Редактирование атрибутов пользователя |
| SR-F072 | Блокировка пользователя для временного запрета доступа |
| SR-F073 | Поддержка четырёх ролей пользователей |
| SR-F074 | Автоматическое назначение прав для должности «Технический директор» |
| SR-F075 | Назначение пользователя администратором конкретного IT-сервиса |
| SR-F076 | Один пользователь — администратор нескольких сервисов |
| SR-F077 | Несколько администраторов для одного сервиса |
| SR-F078 | Индивидуальные права доступа к IT-сервису |
| SR-F079 | Управление правами конкретного сервиса администратором этого сервиса |
| SR-F080 | Администратор сервиса назначает роли «Специалист» и «Обычный сотрудник» |
| SR-F081 | Разграничение доступа к функциям на основе роли |
| SR-F082 | Отображение реестра сервисов только с учётом прав доступа |
| SR-F083 | Сервис доступен, если есть доступ хотя бы к одному элементу документации |
| SR-F104 | Скрытие элементов редактирования от пользователей без прав |
| SR-F105 | Сообщение «Доступ запрещён» при обходе интерфейса |
| SR-SEC004 | Разграничение доступа в соответствии с ролью |
| SR-SEC005 | Запрет CRUD-операций без соответствующих прав |
| SR-SEC006 | Отображение только доступных сервисов |
| SR-SEC007 | Защита от манипуляции параметрами запроса и сеансом |

### Требования к ПО (SWR)

| ID | Требование |
| --- | --- |
| SWR-API013 | `GET /api/v1/users` — список пользователей (только администратор) |
| SWR-API014 | Endpoint доступен только Администратору системы |
| SWR-API015 | `POST /api/v1/users` — создание пользователя |
| SWR-API016 | HTTP 201 при успешном создании (без пароля в ответе) |
| SWR-API017 | Автоматическое назначение роли для «Технического директора» |
| SWR-API020 | `POST /api/v1/users/{id}/block` — блокировка |
| SWR-API021 | Инвалидация всех refresh tokens при блокировке |
| SWR-API044 | `GET /api/v1/services/{id}/permissions` — права доступа к сервису |
| SWR-API045 | `POST /api/v1/services/{id}/permissions` — назначение прав |
| SWR-API046 | Допустимые роли: `service_admin`, `maintenance_specialist`, `regular_user` |
| SWR-API047 | `DELETE /api/v1/services/{id}/permissions/{user_id}` — отзыв прав |
| SWR-API059 | Фильтрация документации: обычному сотруднику — только `user_docs` |
| SWR-API060 | Администраторам и специалистам — все документы |
| SWR-DB001 | Таблица `users` (is_system_admin, is_blocked) |
| SWR-DB007 | Таблица `service_permissions` (service_id, user_id, role) |
| SWR-DB008 | Уникальный индекс `unique(service_id, user_id)` |
| SWR-F001 | Валидация username (3-50 символов, латиница, цифры, _) |
| SWR-F002 | Валидация email |
| SWR-F003 | Валидация пароля (8+ символов, заглавная, строчная, цифра) |

### Трассировка в цепочке

```
TS-F025..TS-F031  →  SR-F068..SR-F081    →  SWR-API013..SWR-API047
TS-F056, TS-F057  →  SR-F104, SR-F105    →  SWR-DB001, SWR-DB007..DB008
TS-F060           →  SR-SEC004..SEC007   →  SWR-F001..SWR-F003
```

---

## План верификации

### 1. Формальная инспекция требований

- Инспекция TS-F025 — TS-F031, TS-F056, TS-F057, TS-F060: полнота описания ролей, непротиворечивость прав
- Инспекция SR-F068 — SR-F081, SR-SEC004 — SR-SEC007: полнота матрицы доступа, отсутствие пропусков
- Инспекция SWR-API044 — SWR-API047: корректность спецификации endpoints прав доступа
- Проверка трассируемости через всю цепочку ТЗ → SR → SWR

### 2. Unit-тестирование (Backend)

| Тест-кейс | Описание | Ожидание |
| --- | --- | --- |
| Создание пользователя | POST с валидными данными | HTTP 201, пароль не в ответе |
| Дублирование логина | POST с существующим username | HTTP 409 |
| Авто-роль Тех. директора | Создание с должностью «Технический директор» | is_system_admin = true |
| Блокировка пользователя | POST /users/{id}/block | Все refresh tokens инвалидированы |
| Назначение прав | POST /services/{id}/permissions | Связь user-service-role создана |
| Дублирование назначения | Повторное назначение тому же пользователю | HTTP 409 |
| Отзыв прав | DELETE /services/{id}/permissions/{user_id} | Связь удалена |
| Доступ к сервисам | GET /services от обычного сотрудника | Только сервисы с назначенными правами |
| Фильтрация документации | GET /documents от обычного сотрудника | Только `user_docs` |
| Запрет редактирования | PUT /services/{id} от обычного сотрудника | HTTP 403 |

### 3. Тестирование безопасности

| Тест-кейс | Описание | Ожидание |
| --- | --- | --- |
| Горизонтальная эскалация | Обычный сотрудник запрашивает чужой сервис по ID | HTTP 403 |
| Вертикальная эскалация | Специалист по обслуживанию пытается удалить сервис | HTTP 403 |
| Манипуляция ID | Подмена service_id в URL | HTTP 403 |
| Обход через API | Прямой запрос к скрытому endpoint | HTTP 403, «Доступ запрещён» |
| Блокированный пользователь | Запрос с токеном заблокированного | HTTP 403 |
| Истёкший токен | Запрос с просроченным access token | HTTP 401 |
| Права после отзыва | Запрос после DELETE /permissions | HTTP 403 |
| Администратор сервиса A → сервис B | Попытка управлять чужим сервисом | HTTP 403 |

### 4. Комбинаторное тестирование ролей

Матрица доступа: 4 роли × N операций. Каждая ячейка — отдельный тест-кейс:

| Операция | Админ системы | Админ сервиса | Специалист | Сотрудник |
| --- | --- | --- | --- | --- |
| Создание сервиса | Да | Нет | Нет | Нет |
| Редактирование сервиса | Да | Да (свой) | Нет | Нет |
| Удаление сервиса | Да | Нет | Нет | Нет |
| Загрузка документации | Да | Да (свой) | Нет | Нет |
| Просмотр всех документов | Да | Да (свой) | Да (свой) | Нет |
| Просмотр «для пользователей» | Да | Да | Да | Да (свой) |
| Регистрация обслуживания | Да | Нет | Да (свой) | Нет |
| Назначение прав | Да | Да (свой) | Нет | Нет |
| Управление пользователями | Да | Нет | Нет | Нет |
| Просмотр аудита | Да | Да (свой) | Нет | Нет |

### 5. UI-тестирование (Frontend)

| Тест-кейс | Описание |
| --- | --- |
| Скрытие элементов | Кнопки «Редактировать», «Удалить» скрыты для пользователей без прав |
| Навигация по ролям | Разделы «Категории», «Пользователи» скрыты для неадминистраторов |
| Интерфейс назначения прав | Администратор сервиса видит таблицу пользователей и может назначать роли |
| Фильтрация каталога | Обычный сотрудник видит только «синие» (пользовательские) документы |
| Блокировка сессии | После блокировки пользователя автоматический выход из системы |

---

## Затрагиваемые компоненты системы

| Слой | Компонент | Технология |
| --- | --- | --- |
| База данных | Таблицы `users`, `service_permissions` | PostgreSQL 16 |
| Backend | Модуль `users` (6 endpoints) | FastAPI, SQLAlchemy |
| Backend | Модуль `services/permissions` (3 endpoints) | FastAPI, SQLAlchemy |
| Backend | Middleware авторизации (каждый endpoint) | FastAPI Depends |
| Frontend | Условный рендеринг по ролям | React, Zustand |
| Безопасность | JWT, bcrypt, проверка прав | python-jose, passlib |

---

## Плюсы выбора

- **Критичность модуля** — приоритет Must have; ошибка в правах доступа — это уязвимость безопасности
- **Масштаб покрытия** — модуль пронизывает всю систему, верификация затрагивает практически каждый endpoint
- **Богатая комбинаторика** — 4 роли × десятки операций × контекст конкретных сервисов = сотни тест-кейсов
- **Тестирование безопасности** — эскалация привилегий, обход авторизации — это серьёзная верификация
- **Практическая значимость** — преподаватель увидит, что верификация выявляет реальные уязвимости

## Минусы выбора

- **Не уникален как концепция** — ролевая модель доступа есть во многих проектах; нужно будет доказать, что именно наша реализация (двухуровневая, с правами на уровне сервисов) нетривиальна
- **Размытые границы модуля** — авторизация пронизывает всю систему, что затрудняет чёткое выделение «области верификации»; можно утонуть в объёме
- **Высокий объём тест-кейсов** — комбинаторная матрица (4 роли × N операций × M сервисов) может оказаться слишком большой для демонстрации
- **Зависимость от других модулей** — для полноценного тестирования прав нужны работающие модули сервисов, документации, обслуживания
- **Сложность формальной инспекции** — требования по ролям разбросаны по нескольким разделам ТЗ и SR, что усложняет инспекцию
